<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>argo-workflows-guide | Earl Wong</title><meta name="author" content="Earl Wong"><meta name="copyright" content="Earl Wong"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Argo Workflows 是一个云原生的通用的工作流引擎。本教程主要介绍如何用其完成持续集成（Continous Integration, CI）任务。 基本概念对任何工具的基本概念有一致的认识和理解，是我们学习以及与他人交流的基础。 以下是本文涉及到的概念：  WorkflowTemplate，工作流模板 Workflow，工作流  为方便读者理解，下面就几个同类工具做对比：    Argo">
<meta property="og:type" content="article">
<meta property="og:title" content="argo-workflows-guide">
<meta property="og:url" content="https://wongearl.github.io/2023/11/17/gitops/argo-workflow-guide/index.html">
<meta property="og:site_name" content="Earl Wong">
<meta property="og:description" content="Argo Workflows 是一个云原生的通用的工作流引擎。本教程主要介绍如何用其完成持续集成（Continous Integration, CI）任务。 基本概念对任何工具的基本概念有一致的认识和理解，是我们学习以及与他人交流的基础。 以下是本文涉及到的概念：  WorkflowTemplate，工作流模板 Workflow，工作流  为方便读者理解，下面就几个同类工具做对比：    Argo">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://wongearl.github.io/img/20230818103122.jpg">
<meta property="article:published_time" content="2023-11-17T01:33:50.000Z">
<meta property="article:modified_time" content="2023-11-17T01:36:13.751Z">
<meta property="article:author" content="Earl Wong">
<meta property="article:tag" content="argo-workflows">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://wongearl.github.io/img/20230818103122.jpg"><link rel="shortcut icon" href="/img/20230823160932.png"><link rel="canonical" href="https://wongearl.github.io/2023/11/17/gitops/argo-workflow-guide/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'argo-workflows-guide',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-11-17 09:36:13'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/20230818103122.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">25</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/thumbbig-1221433.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Earl Wong"><span class="site-name">Earl Wong</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">argo-workflows-guide</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-11-17T01:33:50.000Z" title="发表于 2023-11-17 09:33:50">2023-11-17</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-11-17T01:36:13.751Z" title="更新于 2023-11-17 09:36:13">2023-11-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/gitops/">gitops</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="argo-workflows-guide"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p><a target="_blank" rel="noopener" href="https://argoproj.github.io/argo-workflows/">Argo Workflows</a> 是一个<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Cloud-native_computing">云原生</a>的通用的工作流引擎。本教程主要介绍如何用其完成持续集成（Continous Integration, CI）任务。</p>
<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p>对任何工具的基本概念有一致的认识和理解，是我们学习以及与他人交流的基础。</p>
<p>以下是本文涉及到的概念：</p>
<ul>
<li>WorkflowTemplate，工作流模板</li>
<li>Workflow，工作流</li>
</ul>
<p>为方便读者理解，下面就几个同类工具做对比：</p>
<table>
<thead>
<tr>
<th>Argo Workflow</th>
<th>Jenkins</th>
</tr>
</thead>
<tbody><tr>
<td>WorkflowTemplate</td>
<td>Pipeline</td>
</tr>
<tr>
<td>Workflow</td>
<td>Build</td>
</tr>
</tbody></table>
<h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><ul>
<li>把所有 Workflow YAML 文件存到一个 Git 仓库（例如：<code>infra/workflows</code>）中，并利用 <a target="_blank" rel="noopener" href="https://github.com/devops-ws/argo-cd-guide">Argo CD</a> 同步到 Kubernetes 集群</li>
<li>团队之间共用的部分封装为 <code>ClusterWorkflowTemplate</code></li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>首先，你需要有一套 <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/">Kubernetes</a> 环境。下面的工具可以帮助你快速按照好一套 Kubernetes 环境：</p>
<blockquote>
<p>推荐使用 <a target="_blank" rel="noopener" href="https://github.com/LinuxSuRen/http-downloader">hd</a> 安装下面的工具</p>
<p>安装 <code>hd</code> 的命令为：<code>curl https://linuxsuren.github.io/tools/install.sh|bash</code></p>
</blockquote>
<table>
<thead>
<tr>
<th>工具</th>
<th>工具安装</th>
<th>使用</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://k3d.io/">k3d</a></td>
<td><code>hd i k3d</code></td>
<td><code>k3d cluster create</code></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://github.com/kubesphere/kubekey">kubekey</a></td>
<td><code>hd i kk</code></td>
<td><code>kk create cluster</code></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://github.com/kubernetes/minikube">minikube</a></td>
<td><code>hd i minikube</code></td>
<td><code>minikube start</code></td>
</tr>
</tbody></table>
<p>当 Kubernetes 环境就绪后，就可以通过下面的命令会在命名空间（<code>argo</code>）下安装最新版本的 <code>Argo Workflow</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create namespace argo</span><br><span class="line">kubectl apply -n argo -f https://github.com/argoproj/argo-workflows/releases/latest/download/install.yaml</span><br></pre></td></tr></table></figure>

<p>如果你的环境访问 GitHub 时有网络问题，可以使用下面的命令来安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --rm -v $HOME/.kube/:/root/.kube --network host --pull always ghcr.io/linuxsuren/argo-workflows-guide:master</span><br></pre></td></tr></table></figure>

<p>推荐使用的工具：</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://k9scli.io/">k9s</a></td>
<td>K9s is a terminal based UI to interact with your Kubernetes clusters.</td>
</tr>
</tbody></table>
<h2 id="设置访问方式"><a href="#设置访问方式" class="headerlink" title="设置访问方式"></a>设置访问方式</h2><p>我们可以用下面的方式或者其他方式来设置 Argo Workflows 的访问端口：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n argo port-forward deploy/argo-server --address 0.0.0.0 2746:2746</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">或者设置为 NodePort</span></span><br><span class="line">kubectl -n argo patch svc argo-server --type=&#x27;json&#x27; -p &#x27;[&#123;&quot;op&quot;:&quot;replace&quot;, &quot;path&quot;:&quot;/spec/type&quot;, &quot;value&quot;:&quot;NodePort&quot;&#125;, &#123;&quot;op&quot;:&quot;add&quot;, &quot;path&quot;:&quot;/spec/ports/0/nodePort&quot;,&quot;value&quot;:31517&#125;]&#x27;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">暴露 k3d 端口</span></span><br><span class="line">k3d node edit k3d-k3s-default-serverlb --port-add 31517:31517</span><br></pre></td></tr></table></figure>

<blockquote>
<p>需要注意的是，这里默认的配置下，服务器设置了自签名的证书提供 HTTPS 服务，因此，确保你使用 <code>https://</code> 协议进行访问。</p>
</blockquote>
<p>例如，地址为：<code>https://10.121.218.242:2746/</code></p>
<p>Argo Workflows UI 提供了多种认证登录方式，对于学习、体验等场景，我们可以通过下面的命令直接设置绕过登录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch deployment \</span><br><span class="line">  argo-server \</span><br><span class="line">  --namespace argo \</span><br><span class="line">  --type=&#x27;json&#x27; \</span><br><span class="line">  -p=&#x27;[&#123;&quot;op&quot;: &quot;replace&quot;, &quot;path&quot;: &quot;/spec/template/spec/containers/0/args&quot;, &quot;value&quot;: [</span><br><span class="line">  &quot;server&quot;,</span><br><span class="line">  &quot;--auth-mode=server&quot;</span><br><span class="line">]&#125;]&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="简单示例"><a href="#简单示例" class="headerlink" title="简单示例"></a>简单示例</h2><p>下面是一个非常简单的示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | kubectl apply -n default -f -</span><br><span class="line">apiVersion: argoproj.io/v1alpha1</span><br><span class="line">kind: WorkflowTemplate</span><br><span class="line">metadata:</span><br><span class="line">  name: hello-world</span><br><span class="line">spec:</span><br><span class="line">  entrypoint: hd # 执行入口，类似于 Go、Java 语言的的 main 函数</span><br><span class="line">  templates:</span><br><span class="line">  - container:</span><br><span class="line">      args:</span><br><span class="line">      - search</span><br><span class="line">      - kubectl</span><br><span class="line">      command:</span><br><span class="line">      - hd</span><br><span class="line">      image: ghcr.io/linuxsuren/hd:v0.0.70 # 任务镜像</span><br><span class="line">      name: main</span><br><span class="line">    name: hd</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>执行成功后，就可以在下面的地址访问到刚刚创建的工作流模板：</p>
<p><code>https://10.121.218.242:2746/workflow-templates/default</code></p>
<p>选择其中一个模板，点击 <code>SUBMIT</code> 按钮，并设置对应的参数后即可触发工作流的执行。</p>
<p>在 Workflows 的详情页面中，我们做如下的操作：</p>
<ul>
<li>RESUBMIT，使用相同的模板以及参数触发一次新的执行</li>
</ul>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>通过前面的步骤，我们可以观察到 Argo Workflow 有如下特点：</p>
<ul>
<li>需要具备基本的容器知识</li>
<li>需要熟悉 Kubernetes 的基本资源，例如：PodTemplate、ConfigMap、Secret、Volume 等</li>
<li>实现特定任务，基本上是需要寻找官方提供的镜像，或自行构建镜像</li>
</ul>
<h2 id="完整示例"><a href="#完整示例" class="headerlink" title="完整示例"></a>完整示例</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | kubectl apply -n default -f -</span><br><span class="line">apiVersion: argoproj.io/v1alpha1</span><br><span class="line">kind: WorkflowTemplate</span><br><span class="line">metadata:</span><br><span class="line">  name: gogit</span><br><span class="line">spec:</span><br><span class="line">  entrypoint: main                  # 执行入口</span><br><span class="line">  arguments:</span><br><span class="line">    # 工作流全局参数</span><br><span class="line">    parameters:</span><br><span class="line">      - name: repo</span><br><span class="line">        value: https://github.com/linuxsuren/gogit</span><br><span class="line">      - name: branch</span><br><span class="line">        value: master</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">Volume 模板申明，用于工作流中多个 Pod 之间共享存储</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">例如：克隆代码、构建代码的 Pod 之间共享目录</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">动态创建 Volume，与当前工作流的生命流程保持一致</span></span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">    - metadata:</span><br><span class="line">        name: work</span><br><span class="line">      spec:</span><br><span class="line">        accessModes: [&quot;ReadWriteOnce&quot;]</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            storage: 64Mi</span><br><span class="line"></span><br><span class="line">  templates:</span><br><span class="line">  - name: main</span><br><span class="line">    dag:</span><br><span class="line">      tasks:</span><br><span class="line">        - name: clone</span><br><span class="line">          template: clone   # 引用下面的模板，并传入参数</span><br><span class="line">          arguments:</span><br><span class="line">            parameters:</span><br><span class="line">              - name: repo</span><br><span class="line">                value: &quot;&#123;&#123;workflow.parameters.repo&#125;&#125;&quot;</span><br><span class="line">              - name: branch</span><br><span class="line">                value: &quot;&#123;&#123;workflow.parameters.branch&#125;&#125;&quot;</span><br><span class="line">        - name: build</span><br><span class="line">          template: build</span><br><span class="line">          depends: clone # 通过 depends 设置执行任务之间的顺序关系</span><br><span class="line">  </span><br><span class="line">  - name: clone</span><br><span class="line">    inputs:</span><br><span class="line">      parameters:</span><br><span class="line">        - name: repo</span><br><span class="line">        - name: branch</span><br><span class="line">    container:</span><br><span class="line">      volumeMounts:</span><br><span class="line">        - mountPath: /work              # 共享该目录</span><br><span class="line">          name: work</span><br><span class="line">      image: alpine/git:v2.26.2</span><br><span class="line">      workingDir: /work                 # 代码会克隆到这个目录中</span><br><span class="line">      args:</span><br><span class="line">        - clone</span><br><span class="line">        - --depth</span><br><span class="line">        - &quot;1&quot;</span><br><span class="line">        - --branch</span><br><span class="line">        - &quot;&#123;&#123;=sprig.trimPrefix(&#x27;refs/heads/&#x27;, inputs.parameters[&#x27;branch&#x27;])&#125;&#125;&quot;       # 利用模板函数处理分支名称</span><br><span class="line">        - --single-branch</span><br><span class="line">        - &quot;&#123;&#123;inputs.parameters.repo&#125;&#125;&quot;</span><br><span class="line">        - .</span><br><span class="line">  - name: build</span><br><span class="line">    container:</span><br><span class="line">      image: golang:1.19</span><br><span class="line">      volumeMounts:</span><br><span class="line">        - name: work</span><br><span class="line">          mountPath: /work</span><br><span class="line">      workingDir: /work</span><br><span class="line">      env:</span><br><span class="line">        - name: GOPROXY     # 根据需要来设置相应的环境变量，例如这里的 Golang 代理</span><br><span class="line">          value: https://goproxy.io,direct</span><br><span class="line">      command:</span><br><span class="line">        - make</span><br><span class="line">      args:</span><br><span class="line">        - build             # 执行 Makefile 中的 build 指令来构建 Golang 代码</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h3><p>通过上面的例子，我们可以看到 Argo Workflows 的如下特点：</p>
<ul>
<li>一个工作流中的多个任务之间默认是并行执行的，如果希望顺序执行则可以通过 <code>depends</code> 设置</li>
<li>工作流中可以申明多个任务模板，只有被 <code>entrypoint</code> 引用到的模板才会被执行</li>
<li>每执行一个任务都会对应启动一个 Pod</li>
<li>一个工作流之间的多个任务需要共享目录的话，需要挂载 Volume</li>
<li>对于参数格式的处理，我们可以利用模板函数来实现</li>
</ul>
<h2 id="构建镜像"><a href="#构建镜像" class="headerlink" title="构建镜像"></a>构建镜像</h2><p>这里，我以构建并推送镜像到私有镜像仓库（例如： <a target="_blank" rel="noopener" href="https://github.com/devops-ws/harbor-guide">Harbor</a> ）中为例，分享 Argo Workflows 的使用。</p>
<p>下面是这个例子中用到的相关工具：</p>
<ul>
<li>构建工具 <a target="_blank" rel="noopener" href="https://github.com/moby/buildkit">buildkit</a></li>
<li>私有 Git 仓库</li>
<li>私有镜像仓库</li>
</ul>
<p>准备工作：</p>
<ul>
<li>在集群中的每个节点上<a target="_blank" rel="noopener" href="https://github.com/devops-ws/harbor-guide#docker-daemon">配置 Docker 支持 HTTP 镜像地址</a></li>
<li>创建 Git 凭据<ul>
<li><code>kubectl create secret generic gitlab-secret -n default --dry-run=client -oyaml --from-file=id_rsa=/root/.ssh/id_rsa --from-file=known_hosts=/root/.ssh/known_hosts --from-literal=token=h-zez9CWzyzykbLoS53s</code></li>
</ul>
</li>
<li>创建 Docker 凭据（下面已包含）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">执行下面的命令登录 Harbor</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker login 10.121.218.184:30002 -uyour-username -pyour-password</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://github.com/moby/buildkit/blob/master/docs/buildkitd.toml.md</span></span><br><span class="line">kubectl create secret generic harbor --from-file=config.json=/root/.docker/config.json -n default</span><br><span class="line">cat &lt;&lt;EOF | kubectl apply -n default -f -</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  buildkitd.toml: |</span><br><span class="line">    debug = false</span><br><span class="line">    [worker.containerd]</span><br><span class="line">      namespace = &quot;buildkit&quot;</span><br><span class="line">    [registry.&quot;10.121.218.184:30002&quot;]       # 支持从私有镜像仓库中拉取镜像</span><br><span class="line">      http = true</span><br><span class="line">      insecure = true</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: buildkit</span><br><span class="line">---</span><br><span class="line">apiVersion: argoproj.io/v1alpha1</span><br><span class="line">kind: WorkflowTemplate</span><br><span class="line">metadata:</span><br><span class="line">  name: image-build</span><br><span class="line">spec:</span><br><span class="line">  entrypoint: main</span><br><span class="line">  arguments:</span><br><span class="line">    parameters:</span><br><span class="line">      - name: repo</span><br><span class="line">        value: git@10.121.218.82:demo/hello-world.git</span><br><span class="line">      - name: branch</span><br><span class="line">        value: master</span><br><span class="line"></span><br><span class="line">  volumeClaimTemplates:                           # 用于在多个 Pod 之间共享代码</span><br><span class="line">    - metadata:</span><br><span class="line">        name: work</span><br><span class="line">      spec:</span><br><span class="line">        accessModes: [&quot;ReadWriteOnce&quot;]</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            storage: 64Mi</span><br><span class="line"></span><br><span class="line">  templates:</span><br><span class="line">  - name: main</span><br><span class="line">    dag:</span><br><span class="line">      tasks:</span><br><span class="line">        - name: clone</span><br><span class="line">          template: clone</span><br><span class="line">          arguments:</span><br><span class="line">            parameters:</span><br><span class="line">              - name: repo</span><br><span class="line">                value: &quot;&#123;&#123;workflow.parameters.repo&#125;&#125;&quot;</span><br><span class="line">              - name: branch</span><br><span class="line">                value: &quot;&#123;&#123;workflow.parameters.branch&#125;&#125;&quot;</span><br><span class="line">        - name: image</span><br><span class="line">          template: image</span><br><span class="line">          depends: clone</span><br><span class="line">          arguments:</span><br><span class="line">            parameters:</span><br><span class="line">              - name: image</span><br><span class="line">                value: demo/hello-world</span><br><span class="line">              - name: dockerfile</span><br><span class="line">                value: .</span><br><span class="line"></span><br><span class="line">  - name: clone</span><br><span class="line">    inputs:</span><br><span class="line">      parameters:</span><br><span class="line">        - name: repo</span><br><span class="line">        - name: branch</span><br><span class="line">    volumes:</span><br><span class="line">      - name: git-secret</span><br><span class="line">        secret:</span><br><span class="line">          defaultMode: 0400</span><br><span class="line">          secretName: gitlab-secret</span><br><span class="line">    container:</span><br><span class="line">      volumeMounts:</span><br><span class="line">        - mountPath: /work</span><br><span class="line">          name: work</span><br><span class="line">        - mountPath: /root/.ssh/</span><br><span class="line">          name: git-secret</span><br><span class="line">      image: alpine/git:v2.26.2</span><br><span class="line">      workingDir: /work</span><br><span class="line">      args:</span><br><span class="line">        - clone</span><br><span class="line">        - --depth</span><br><span class="line">        - &quot;1&quot;</span><br><span class="line">        - --branch</span><br><span class="line">        - &quot;&#123;&#123;inputs.parameters.branch&#125;&#125;&quot;</span><br><span class="line">        - --single-branch</span><br><span class="line">        - &quot;&#123;&#123;inputs.parameters.repo&#125;&#125;&quot;</span><br><span class="line">        - .</span><br><span class="line">  - name: image</span><br><span class="line">    inputs:</span><br><span class="line">      parameters:</span><br><span class="line">        - name: image</span><br><span class="line">        - name: dockerfile</span><br><span class="line">hostAliases:					# 关联 IP 和主机名</span><br><span class="line">      - ip: &quot;192.168.21.110&quot;</span><br><span class="line">        hostnames:</span><br><span class="line">        - &quot;your.com&quot;</span><br><span class="line">    volumes:</span><br><span class="line">      - name: docker-config</span><br><span class="line">        secret:</span><br><span class="line">          secretName: harbor                        # 这里需要和上面创建的 Secret 名称保持一致</span><br><span class="line">      - name: cache</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /mnt/data</span><br><span class="line">          type: DirectoryOrCreate</span><br><span class="line">      - name: buildkit</span><br><span class="line">        configMap:</span><br><span class="line">          name: buildkit</span><br><span class="line">    container:</span><br><span class="line">      image: moby/buildkit:v0.9.3-rootless</span><br><span class="line">      volumeMounts:</span><br><span class="line">        - name: work</span><br><span class="line">          mountPath: /work</span><br><span class="line">        - name: docker-config</span><br><span class="line">          mountPath: /.docker</span><br><span class="line">        - name: cache</span><br><span class="line">          mountPath: /cache</span><br><span class="line">        - mountPath: /etc/buildkit/</span><br><span class="line">          name: buildkit</span><br><span class="line">      workingDir: /work/</span><br><span class="line">      securityContext:</span><br><span class="line">        privileged: true</span><br><span class="line">      env:</span><br><span class="line">        - name: BUILDKITD_FLAGS</span><br><span class="line">          value: --oci-worker-no-process-sandbox --config=/etc/buildkit/buildkitd.toml # 支持从 HTTP 地址拉取镜像</span><br><span class="line">        - name: DOCKER_CONFIG</span><br><span class="line">          value: /.docker</span><br><span class="line">      command:</span><br><span class="line">        - buildctl-daemonless.sh</span><br><span class="line">      args:</span><br><span class="line">        - build</span><br><span class="line">        - --frontend</span><br><span class="line">        - dockerfile.v0</span><br><span class="line">        - --local</span><br><span class="line">        - context=.</span><br><span class="line">        - --local</span><br><span class="line">        - dockerfile=&#123;&#123;inputs.parameters.dockerfile&#125;&#125;</span><br><span class="line">        - --output</span><br><span class="line">        - type=image,name=10.121.218.184:30002/&#123;&#123;inputs.parameters.image&#125;&#125;,push=true,registry.insecure=true   # 支持推送的 HTTP 地址</span><br><span class="line">        - --opt</span><br><span class="line">        - build-arg:GOPROXY=http://goproxy.goproxy.svc:8081,direct        # 设置内网 Go 缓存代理</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>需要在每个构建节点上执行如下的命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 15000 &gt; /proc/sys/user/max_user_namespaces</span><br></pre></td></tr></table></figure>

<p>除了 <code>buildkit</code> 以外，也可以考虑使用 <code>kaniko</code>（你可以从 <a href="templates/library.yaml">library.yaml</a>中找到对应的配置）。</p>
<h3 id="小结-2"><a href="#小结-2" class="headerlink" title="小结"></a>小结</h3><p>在上面的例子中，有如下几点需要注意的：</p>
<ul>
<li>采用 buildkit 构建镜像，避免挂载本地 Docker 的 <code>/var/run/docker.sock</code> 文件</li>
<li>上面的例子，在 Kubernetes 集群不以 Docker 作为<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/">容器运行</a>时也能正常使用</li>
<li>在实际使用过程中，有遇到过 buildkit 报错的情况，可以考虑增加重试机制进一步保障构建成功</li>
<li><code>registry.insecure=true</code> 这个参数对于私有化环境中没有证书的情况非常重要</li>
<li>buildkit 还支持缓存持久化，从而加快构建速度，有兴趣的朋友可以翻阅官方文档，或帮助完善这里的例子</li>
<li>Go 缓存代理是可选的，但推荐在内网中部署以加快依赖下载速度</li>
</ul>
<h2 id="循环任务"><a href="#循环任务" class="headerlink" title="循环任务"></a>循环任务</h2><p>Argo Workflow 的 <a target="_blank" rel="noopener" href="https://argoproj.github.io/argo-workflows/walk-through/loops/">Loop</a> 功能，可以简化重复的任务，方便维护。以下是一个例子：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | kubectl apply -n default -f -</span><br><span class="line">apiVersion: argoproj.io/v1alpha1</span><br><span class="line">kind: WorkflowTemplate</span><br><span class="line">metadata:</span><br><span class="line">  name: output</span><br><span class="line">spec:</span><br><span class="line">  entrypoint: main</span><br><span class="line"></span><br><span class="line">  templates:</span><br><span class="line">  - name: main</span><br><span class="line">    dag:</span><br><span class="line">      tasks:</span><br><span class="line">        - name: build-image</span><br><span class="line">          template: build-image</span><br><span class="line">          depends: clone</span><br><span class="line">          arguments:</span><br><span class="line">            parameters:</span><br><span class="line">              - name: version</span><br><span class="line">                value: &quot;&#123;&#123;tasks.clone.outputs.parameters.version&#125;&#125;&quot;</span><br><span class="line">  - name: build-image</span><br><span class="line">    inputs:</span><br><span class="line">      parameters:</span><br><span class="line">        - name: version</span><br><span class="line">          default: &quot;&quot;</span><br><span class="line">    steps:</span><br><span class="line">    - - name: image</span><br><span class="line">        templateRef:</span><br><span class="line">          name: library</span><br><span class="line">          template: image</span><br><span class="line">          clusterScope: true</span><br><span class="line">        arguments:</span><br><span class="line">          parameters:</span><br><span class="line">            - name: image</span><br><span class="line">              value: al-cloud/&#123;&#123;item.name&#125;&#125;:&#123;&#123;inputs.parameters.version&#125;&#125;</span><br><span class="line">            - name: dockerfile</span><br><span class="line">              value: build/&#123;&#123;item.context&#125;&#125;</span><br><span class="line">            - name: tag</span><br><span class="line">              value: &quot;&#123;&#123;inputs.parameters.version&#125;&#125;&quot;</span><br><span class="line">        withItems: # 设置循环的参数</span><br><span class="line">        - &#123; name: &#x27;apiserver&#x27;, context: &#x27;al-cloud&#x27; &#125;</span><br><span class="line">        - &#123; name: &#x27;controller&#x27;, context: &#x27;component-manager&#x27; &#125;</span><br><span class="line">        - &#123; name: &#x27;app-template&#x27;, context: &#x27;app-template&#x27; &#125;</span><br><span class="line">        - &#123; name: &#x27;manifest&#x27;, context: &#x27;manifest&#x27; &#125;</span><br><span class="line">        - &#123; name: &#x27;agent&#x27;, context: &#x27;agent&#x27; &#125;</span><br><span class="line">        - &#123; name: &#x27;api-test&#x27;, context: &#x27;api-test&#x27; &#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h2 id="结果输出与引用"><a href="#结果输出与引用" class="headerlink" title="结果输出与引用"></a>结果输出与引用</h2><p>Argo Workflows 支持制品（artifact）与变量的输出，下面是变量输出以及引用的例子：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | kubectl apply -n default -f -</span><br><span class="line">apiVersion: argoproj.io/v1alpha1</span><br><span class="line">kind: WorkflowTemplate</span><br><span class="line">metadata:</span><br><span class="line">  name: output</span><br><span class="line">spec:</span><br><span class="line">  entrypoint: main</span><br><span class="line"></span><br><span class="line">  templates:</span><br><span class="line">  - name: main</span><br><span class="line">    dag:</span><br><span class="line">      tasks:</span><br><span class="line">        - name: version</span><br><span class="line">          template: version</span><br><span class="line">        - name: print</span><br><span class="line">          template: print</span><br><span class="line">          depends: version</span><br><span class="line">          arguments:</span><br><span class="line">            parameters:</span><br><span class="line">              - name: version</span><br><span class="line">                value: &quot;&#123;&#123;tasks.version.outputs.parameters.version&#125;&#125;&quot;       # 引用输出变量</span><br><span class="line">  - name: version</span><br><span class="line">    container:</span><br><span class="line">      image: alpine/git:v2.26.2</span><br><span class="line">      command:</span><br><span class="line">      - sh</span><br><span class="line">      - -c</span><br><span class="line">      - &#x27;echo v1.1 &gt; /tmp/version&#x27;         # 将期望输出的内容写入文件</span><br><span class="line">    outputs:</span><br><span class="line">      parameters:</span><br><span class="line">      - name: version</span><br><span class="line">        valueFrom:</span><br><span class="line">          path: /tmp/version               # 读取容器中的文件，并作为内容输出到变量 version 中</span><br><span class="line">  - name: print</span><br><span class="line">    inputs:</span><br><span class="line">      parameters:</span><br><span class="line">        - name: version                    # 定义输入变量</span><br><span class="line">    container:</span><br><span class="line">      image: alpine</span><br><span class="line">      command:</span><br><span class="line">      - sh</span><br><span class="line">      - -c</span><br><span class="line">      - &#x27;echo &#123;&#123;inputs.parameters.version&#125;&#125;&#x27;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h2 id="Webhook"><a href="#Webhook" class="headerlink" title="Webhook"></a>Webhook</h2><p>所有主流 Git 仓库都是支持 webhook 的，借助 webhook 可以当代码发生变化后实时地触发工作流的执行。</p>
<p>Argo Workflows 利用 <code>WorkflowEventBinding</code> 将收到的 webhook 请求与 WorkflowTemplate 做关联。请参考下面的例子：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF kubectl apply -n default -f -</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  name: submit-workflow-template</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - argoproj.io</span><br><span class="line">    resources:</span><br><span class="line">      - workfloweventbindings</span><br><span class="line">    verbs:</span><br><span class="line">      - list</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - argoproj.io</span><br><span class="line">    resources:</span><br><span class="line">      - workflowtemplates</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - argoproj.io</span><br><span class="line">    resources:</span><br><span class="line">      - workflows</span><br><span class="line">    verbs:</span><br><span class="line">      - create</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: github.com</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: github.com</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: submit-workflow-template</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: github.com</span><br><span class="line">    namespace: default</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">stringData:</span><br><span class="line">  github.com: |			                  # 这里对应 ServiceAcccount 名称</span><br><span class="line">    type: github		                  # 固定的几个类型</span><br><span class="line">    secret: &quot;argo-workflow-secret&quot;    # webhook 中配置的 Secret Token</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: argo-workflows-webhook-clients</span><br><span class="line">type: Opaque</span><br><span class="line">---</span><br><span class="line">apiVersion: argoproj.io/v1alpha1</span><br><span class="line">kind: WorkflowEventBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: pull-request-binding</span><br><span class="line">spec:</span><br><span class="line">  event:</span><br><span class="line">    # 通过 webhook 的 payload 对请求进行过滤，并联动触发对应的工作流模板</span><br><span class="line">    selector: payload.project.name == &quot;gogit&quot; &amp;&amp; payload.object_attributes.state == &quot;opened&quot;</span><br><span class="line">  submit:</span><br><span class="line">    workflowTemplateRef:</span><br><span class="line">      name: gogit       # 关联工作流模板</span><br><span class="line">    arguments:</span><br><span class="line">      parameters:</span><br><span class="line">      - name: branch</span><br><span class="line">        valueFrom:</span><br><span class="line">          # 从 webhook 的 payload 中提取值作为参数</span><br><span class="line">          event: payload.object_attributes.source_branch</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>然后，在代码仓库中添加如下的 webhook 地址（其中，<code>default</code> 是 <code>WorkflowEventBinding</code> 所在的命名空间）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://argo-workflow-ip:port/api/v1/events/default/</span><br></pre></td></tr></table></figure>

<p>上面的 Secret 名称 <code>argo-workflows-webhook-clients</code> 是固定的，所在命名空间也就是 webhook 地址中的 <code>default</code>。支持的 Git Provider 名称也是固定的几个：</p>
<ul>
<li><code>bitbucket</code></li>
<li><code>bitbucketserver</code></li>
<li><code>github</code></li>
<li><code>gitlab</code></li>
</ul>
<h3 id="小结-3"><a href="#小结-3" class="headerlink" title="小结"></a>小结</h3><p>从上面的例子中，我们可以看到：</p>
<ul>
<li>Argo Workflows 以申明式的资源将 webhook 与工作流模板做关联，非常地灵活</li>
<li>webhook 绑定并不局限在 Git 代码仓库上，还可以与其他类型的 webhook 做关联</li>
<li>通过从 webhook 的 payload 中提取值，可以非常方便地为工作流模板参数传递值</li>
</ul>
<h2 id="关联代码仓库"><a href="#关联代码仓库" class="headerlink" title="关联代码仓库"></a>关联代码仓库</h2><p>对于不少的团队而言，会出于各种考虑而选择私有部署 Git 服务，例如：Gitlab、Gitee 等。而将工作流的执行结果与代码仓库的 Pull Request 相关联几乎是一个<strong>标配</strong>。以下是关联后的几点好处：</p>
<ul>
<li>工作流执行失败后阻止 Pull Request 的合并</li>
<li>在 Pull Request 页面中可以直接看到工作流执行状态</li>
</ul>
<p>下面会基于 <a target="_blank" rel="noopener" href="https://github.com/LinuxSuRen/gogit/">https://github.com/LinuxSuRen/gogit/</a> 给出一个关联方案：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | kubectl apply -n default -f -</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  token: eW91ci10b2tlbg==</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: git-secret</span><br><span class="line">type: Opaque</span><br><span class="line">---</span><br><span class="line">apiVersion: argoproj.io/v1alpha1</span><br><span class="line">kind: WorkflowTemplate</span><br><span class="line">metadata:</span><br><span class="line">  name: hook</span><br><span class="line">spec:</span><br><span class="line">  entrypoint: main</span><br><span class="line">  arguments:</span><br><span class="line">    parameters:</span><br><span class="line">      - name: pr</span><br><span class="line">        value: 1</span><br><span class="line">      - name: argoServer</span><br><span class="line">        value: https://localhost:8080</span><br><span class="line"></span><br><span class="line">  hooks:</span><br><span class="line">    exit:                   # 只有 exit 这个 hook 名称是固定的</span><br><span class="line">      template: hook</span><br><span class="line">    all:                    # 这里可以是任意字符串，重点在于 expression 这里的表达式</span><br><span class="line">      template: hook</span><br><span class="line">      expression: &quot;true&quot;    # 可以通过表达式 expression 对事件进行过滤</span><br><span class="line"></span><br><span class="line">  templates:</span><br><span class="line">  - container:</span><br><span class="line">      args:</span><br><span class="line">      - search</span><br><span class="line">      - kubectl</span><br><span class="line">      command:</span><br><span class="line">      - hd</span><br><span class="line">      image: ghcr.io/linuxsuren/hd:v0.0.70 # 任务镜像</span><br><span class="line">      name: main</span><br><span class="line">    name: hd</span><br><span class="line">  - name: hook</span><br><span class="line">    volumes:</span><br><span class="line">      - name: git-secret</span><br><span class="line">        secret:</span><br><span class="line">          defaultMode: 0400</span><br><span class="line">          secretName: git-secret    # 包含 token 字段的 Secret</span><br><span class="line">    container:</span><br><span class="line">      image: ghcr.io/linuxsuren/gogit:master@sha256:4855f4ffbc1644eb7246f94cc9ee12c793ed4c26ba18e1d4d9afa57b72f1e846</span><br><span class="line">      args:</span><br><span class="line">        - --provider=github         # 支持 GitHub、Gitlab 等，私有部署的话需要参数 --server 指定地址</span><br><span class="line">        - --owner=LinuxSuRen        # 根据需要修改 owner、repo、username</span><br><span class="line">        - --repo=gogit</span><br><span class="line">        - --username=LinuxSuRen</span><br><span class="line">        - --token=file:///root/.ssh/token</span><br><span class="line">        - --pr=&#123;&#123;workflow.parameters.pr&#125;&#125;</span><br><span class="line">        - --target=&#123;&#123;workflow.parameters.argoServer&#125;&#125;/workflows/&#123;&#123;workflow.namespace&#125;&#125;/&#123;&#123;workflow.name&#125;&#125;</span><br><span class="line">        - --status=&#123;&#123;workflow.status&#125;&#125;</span><br><span class="line">      volumeMounts:</span><br><span class="line">        - mountPath: /root/.ssh/</span><br><span class="line">          name: git-secret</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>触发上面的工作流后，就会在指定的仓库 Pull Request 上出现构建状态。</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ul>
<li><a target="_blank" rel="noopener" href="https://argoproj.github.io/argo-workflows/lifecyclehook/">官方文档</a></li>
</ul>
<h3 id="小结-4"><a href="#小结-4" class="headerlink" title="小结"></a>小结</h3><p>从这个示例中，我们可以看到：</p>
<ul>
<li>hook 机制依然是非常的灵活，但 expression 表达式可能会是一个具有挑战的部分</li>
<li>hook 机制有点像是 Golang 的 <code>__init</code> 函数，作为特殊的入口，可以调用其他的模板</li>
</ul>
<h2 id="日志持久化"><a href="#日志持久化" class="headerlink" title="日志持久化"></a>日志持久化</h2><p>Argo Workflows 默认不会持久化工作流日志，而是从每个任务对应的 Pod 中获取日志。而对于 Kubernetes 来说，Pod 是一个没有保障的最小执行单元，可能会由于人为或者某种策略被删除。当 Pod 被删除后，日志就无法查看了。因此，对于生产环境而言，必须要持久化日志。</p>
<p>Argo Workflows 执行多种存储协议，以下是兼容 S3 的 MinIO 存储：</p>
<p>首先，下载、安装以及配置 minio。本文仅作学习、演示使用，生产环境中，请按照官方文档进行安装、配置。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hd i minio</span><br><span class="line">minio server /tmp/minio --console-address &quot;:9001&quot;</span><br></pre></td></tr></table></figure>

<p>然后，访问 minio 管理界面 <code>http://localhost:9001</code>，创建名为 <code>argo-workflow</code> 的 <code>bucket</code>。创建 <code>Access Key</code>，并写入下面的 <code>Secret</code> 中。</p>
<p>安装如下配置修改 <code>ConfigMap</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret generic minio-workflow \</span><br><span class="line">  --from-literal=accessKey=supersecret \</span><br><span class="line">  --from-literal=secretKey=topsecret</span><br><span class="line">cat &lt;&lt;EOF | kubectl apply -n default -f -</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: workflow-controller-configmap</span><br><span class="line">  namespace: argo</span><br><span class="line">data:</span><br><span class="line">  artifactRepository: |</span><br><span class="line">    archiveLogs: true          # 全局设置使得所有工作流日志做持久化</span><br><span class="line">    s3:</span><br><span class="line">      bucket: argo-workflow    # 在 minio 中创建的 bucket</span><br><span class="line">      endpoint: minio.minio.svc</span><br><span class="line">      insecure: true                  # 当 minio 没有启用 TLS</span><br><span class="line">      accessKeySecret:</span><br><span class="line">        name: minio-workflow</span><br><span class="line">        key: accessKey</span><br><span class="line">      secretKeySecret:</span><br><span class="line">        name: minio-workflow</span><br><span class="line">        key: secretKey</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>完成上面的配置后，再次执行任意工作流，并将执行完成的 Pod 删除后，我们依然可以在 UI 上查看任务日志。并且，可以在 minio 中看到了新增的文件。每个 Pod 的日志在 minio 中分别以一个文件的形式存储。</p>
<p>我们可以通过 minio 的命令行客户端 <code>mc</code> 看到类似如下的文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mc alias set myminio http://localhost:9001 minioadmin minioadmin</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mc <span class="built_in">ls</span> myminio/argo-workflow -r</span></span><br><span class="line">[2022-12-09 10:53:31 CST]    20B STANDARD hello-world-5mjgp/hello-world-5mjgp-clone-3848310779/main.log</span><br><span class="line">[2022-12-09 10:55:39 CST]  16KiB STANDARD hello-world-5mjgp/hello-world-5mjgp-image-2614052838/main.log</span><br><span class="line">[2022-12-09 10:54:35 CST] 5.9KiB STANDARD hello-world-5mjgp/hello-world-5mjgp-scan-4101005739/main.log</span><br><span class="line">[2022-12-09 10:53:51 CST]   435B STANDARD hello-world-5mjgp/hello-world-5mjgp-test-1532501286/main.log</span><br></pre></td></tr></table></figure>

<h3 id="参考链接-1"><a href="#参考链接-1" class="headerlink" title="参考链接"></a>参考链接</h3><ul>
<li><a target="_blank" rel="noopener" href="https://argoproj.github.io/argo-workflows/configure-artifact-repository/">支持的外部存储类型</a></li>
<li><a target="_blank" rel="noopener" href="https://argoproj.github.io/argo-workflows/configure-archive-logs/">官方文档</a></li>
</ul>
<h3 id="小结-5"><a href="#小结-5" class="headerlink" title="小结"></a>小结</h3><p>通过上面的例子，我们可以看到：</p>
<ul>
<li>Argo Workflows 能以非侵入式的配置，使得工作流日志输出到对象存储等外部存储中</li>
<li>Argo Workflows 的任务有输入、输出（input、output）的概念，日志的持久化是将日志作为输出写入到预先配置好的外部存储</li>
<li>日志的持久化，可以分别在全局 ConfigMap、Workflow Spec、WorkflowTemplate 中配置</li>
</ul>
<h2 id="引用已有模板中的任务"><a href="#引用已有模板中的任务" class="headerlink" title="引用已有模板中的任务"></a>引用已有模板中的任务</h2><p>Argo Workflows 允许以三种方式引用已有的任务：</p>
<ul>
<li>当前工作流</li>
<li>当前命名空间中的工作流模板</li>
<li>全局（Cluster 级别）的工作流模板</li>
</ul>
<p>这相当于 Java、Golang 等编程语言中的引用方式，分别可以引用：当前源文件、当前包、其他包下的函数。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">argoproj.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">WorkflowTemplate</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hello-world</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">templates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hd</span></span><br><span class="line">    <span class="attr">dag:</span></span><br><span class="line">      <span class="attr">tasks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hd</span></span><br><span class="line">        <span class="attr">templateRef:</span>            <span class="comment"># 表示引用其他模板中的任务</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">hook</span>            <span class="comment"># 模板名称</span></span><br><span class="line">          <span class="attr">template:</span> <span class="string">hook</span>        <span class="comment"># 模板中的任务名称</span></span><br><span class="line">          <span class="attr">clusterScope:</span> <span class="literal">true</span>    <span class="comment"># 为 true 是从全局（Cluster）中查找模板，为 false 时从当前命名空间中查找</span></span><br><span class="line">        <span class="attr">arguments:</span></span><br><span class="line">          <span class="attr">parameters:</span>           <span class="comment"># 给所引用的任务传递参数</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pr</span></span><br><span class="line">            <span class="attr">value:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="小结-6"><a href="#小结-6" class="headerlink" title="小结"></a>小结</h3><p>我们可以将公用的模板作为模板库，供工作流调用，这样就可以使得工作流变得简单。</p>
<h2 id="任务模板类型"><a href="#任务模板类型" class="headerlink" title="任务模板类型"></a>任务模板类型</h2><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>容器</td>
<td>指定单个容器</td>
</tr>
<tr>
<td>脚本</td>
<td></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://argoproj.github.io/argo-workflows/container-set-template/">容器集合</a></td>
<td>支持多个容器</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://argoproj.github.io/argo-workflows/walk-through/dag/">Directed-Acyclic Graph (DAG)</a></td>
<td>支持指定任务之间的依赖关系，默认会尽可能地并发执行。</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://argoproj.github.io/argo-workflows/http-template/">HTTP</a></td>
<td>支持发送 HTTP 请求</td>
</tr>
<tr>
<td>资源</td>
<td>直接操作 Kubernetes 资源</td>
</tr>
</tbody></table>
<h2 id="认证模型"><a href="#认证模型" class="headerlink" title="认证模型"></a>认证模型</h2><p>Argo workflows 支持三种认证模型：</p>
<ul>
<li>server<ul>
<li>采用服务端的 ServiceAccount，UI 节目无需登录认证，可作为体验、测试等场景使用</li>
</ul>
</li>
<li>client<ul>
<li>客户端需要提供 Token 等认证信息</li>
<li>从 v3.0+ 开始作为 Argo workflows 的默认认证方式</li>
</ul>
</li>
<li>sso<ul>
<li>后端有对应的 ServiceAccount 选择机制，包括有：优先级、表达式等匹配不同的用户、用户组权限</li>
</ul>
</li>
</ul>
<p>其中，<code>sso</code> 和 <code>client</code> 可以组合使用，分别为：UI、webhook、SDK Client 等提供认证。</p>
<h2 id="SSO"><a href="#SSO" class="headerlink" title="SSO"></a>SSO</h2><p>为了保证 Argo workflows 同时支持 <a target="_blank" rel="noopener" href="https://argoproj.github.io/argo-workflows/argo-server-sso/">SSO(Single Sign-On) </a>以及 webhook 的执行，需要设置认证模式为：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">argo-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">argo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">server</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--auth-mode=sso</span>           <span class="comment"># UI 登录后所有操作使用的权限，参考后面的配置</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--auth-mode=client</span>        <span class="comment"># webhook 触发时采用的权限模式</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">argo-server</span></span><br></pre></td></tr></table></figure>

<p>下面以 <a target="_blank" rel="noopener" href="https://github.com/devops-ws/dex-guide">Dex</a> 为例（需要有：<code>read_user</code>、<code>openid</code> 的授权），给出配置 SSO 信息：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">workflow-controller-configmap</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">argo</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">sso:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    issuer: https://10.121.218.184:31392/api/dex                    # Dex 服务地址</span></span><br><span class="line"><span class="string">    clientId:</span></span><br><span class="line"><span class="string">      name: argo-workflows-sso</span></span><br><span class="line"><span class="string">      key: client-id</span></span><br><span class="line"><span class="string">    clientSecret:</span></span><br><span class="line"><span class="string">      name: argo-workflows-sso</span></span><br><span class="line"><span class="string">      key: client-secret</span></span><br><span class="line"><span class="string">    redirectUrl: https://10.121.218.184:30298/oauth2/callback       # 这里 Argo workflows 的地址必须是浏览器可访问的</span></span><br><span class="line"><span class="string">    insecureSkipVerify: true</span></span><br><span class="line"><span class="string">    scopes:</span></span><br><span class="line"><span class="string">    - groups                        # 用组作为权限划分</span></span><br><span class="line"><span class="string">    - email</span></span><br><span class="line"><span class="string">    rbac:</span></span><br><span class="line"><span class="string">      enabled: true                 # 启用 RBAC 权限认证，下面需要提供对应的配置</span></span><br></pre></td></tr></table></figure>

<p>创建上面所需要的 Secret：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | kubectl apply -f argo -f</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">下面的 client-id、client-secret 可以向 oauth 服务提供者拿到</span></span><br><span class="line">  client-id: YXJnby13b3JrZmxvd3Mtc3Nv</span><br><span class="line">  client-secret: cmljaw==</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: argo-workflows-sso</span><br><span class="line">type: Opaque</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>为 SSO 登录的用户提供只读权限：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | kubectl apply -n argo -f -</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: user-default-login</span><br><span class="line">  annotations:</span><br><span class="line">    workflows.argoproj.io/rbac-rule: &quot;&#x27;dev&#x27; in groups&quot;        # dev 用户组登录后会使用该账号</span><br><span class="line">    workflows.argoproj.io/rbac-rule-precedence: &quot;10&quot;          # 多条规则匹配的情况下，选择数字大的</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF | kubectl apply -n argo -f -</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/instance: argo-workflow</span><br><span class="line">  name: argo-view-default-login-binding</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: argo-aggregate-to-view                          # 内置的只读角色</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: user-default-login</span><br><span class="line">  namespace: argo</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="小结-7"><a href="#小结-7" class="headerlink" title="小结"></a>小结</h3><p>可以给 Argo workflows 配置任意兼容 OAuth 2 的提供商，例如：Dex、GitHub、Gitlab 公有云、Gitlab 社区版、Argo CD 等。</p>
<p>内置的角色包括（以下都是 ClusterRole）：</p>
<ul>
<li><code>argo-aggregate-to-view</code></li>
<li><code>argo-aggregate-to-edit</code></li>
<li><code>argo-aggregate-to-admin</code></li>
<li><code>argo-cluster-role</code>，没有 <code>workfloweventbindings</code> 的权限</li>
<li><code>argo-server-cluster-role</code>，包含所有需要的权限</li>
</ul>
<h2 id="插件机制"><a href="#插件机制" class="headerlink" title="插件机制"></a>插件机制</h2><p>Argo Workflows 内置了<a href="#%E4%BB%BB%E5%8A%A1%E6%A8%A1%E6%9D%BF%E7%B1%BB%E5%9E%8B">几种类型的任务模板</a>，这些任务类型或是方便解决特定问题，或是可以解决通用问题。此外，我们还可以通过<a target="_blank" rel="noopener" href="https://argoproj.github.io/argo-workflows/plugins/">执行器（Executor）插件</a>扩展 Argo Workflows 的功能。</p>
<p>执行器插件，会作为工作流 Pod 中 sidecar 的形式存在，通过 HTTP 提供服务。Argo Workflows 规定了 URI，以及 Request 和 Response。据此，我们可以看出来插件的几个特点：</p>
<ul>
<li>插件可以用任何编程语言实现</li>
<li>执行插件任务时无需启动新的 Pod，减少了对 Pod 的消耗</li>
</ul>
<p>该插件功能默认是未启用的，我们可以在控制器（Controller）中添加环境变量的方式启用插件功能。请参考如下配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">workflow-controller</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">workflow-controller</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ARGO_EXECUTOR_PLUGINS</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br></pre></td></tr></table></figure>

<p>安装插件时，只需要添加一个 ConfigMap 即可。例如：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">sidecar.automountServiceAccountToken:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">  <span class="attr">sidecar.container:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    args:</span></span><br><span class="line"><span class="string">    - --provider</span></span><br><span class="line"><span class="string">    - gitlab</span></span><br><span class="line"><span class="string">    image: ghcr.io/linuxsuren/workflow-executor-gogit:master</span></span><br><span class="line"><span class="string">    command:</span></span><br><span class="line"><span class="string">    - workflow-executor-gogit</span></span><br><span class="line"><span class="string">    name: gogit-executor-plugin</span></span><br><span class="line"><span class="string">    ports:</span></span><br><span class="line"><span class="string">    - containerPort: 3001</span></span><br><span class="line"><span class="string">    resources:</span></span><br><span class="line"><span class="string">      limits:</span></span><br><span class="line"><span class="string">        cpu: 500m</span></span><br><span class="line"><span class="string">        memory: 128Mi</span></span><br><span class="line"><span class="string">      requests:</span></span><br><span class="line"><span class="string">        cpu: 250m</span></span><br><span class="line"><span class="string">        memory: 64Mi</span></span><br><span class="line"><span class="string">    securityContext:</span></span><br><span class="line"><span class="string">      allowPrivilegeEscalation: true</span></span><br><span class="line"><span class="string">      runAsNonRoot: true</span></span><br><span class="line"><span class="string">      runAsUser: 65534</span></span><br><span class="line"><span class="string"></span><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">workflows.argoproj.io/configmap-type:</span> <span class="string">ExecutorPlugin</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gogit-executor-plugin</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">argo</span></span><br></pre></td></tr></table></figure>

<p>我们可以把上面的 ConfigMap 添加到 Argo Workflows 控制器所在的命名空间中，也可以添加到执行工作流所在的命名空间中。另外，当存在多个同名的插件时，会以工作流所在命名空间的插件为主。</p>
<p>插件安装成功的话，你可以在控制器中查看到类似如下的日志输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">level=info msg=&quot;Executor plugin added&quot; name=gogit-executor-plugin</span><br></pre></td></tr></table></figure>

<p>插件的使用方法如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">argoproj.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">WorkflowTemplate</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">plugin</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">entrypoint:</span> <span class="string">main</span></span><br><span class="line">  <span class="attr">hooks:</span></span><br><span class="line">    <span class="attr">exit:</span></span><br><span class="line">      <span class="attr">template:</span> <span class="string">status</span></span><br><span class="line">    <span class="attr">all:</span></span><br><span class="line">      <span class="attr">template:</span> <span class="string">status</span></span><br><span class="line">      <span class="attr">expression:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">templates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">container:</span></span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">search</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">kubectl</span></span><br><span class="line">      <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">hd</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">ghcr.io/linuxsuren/hd:v0.0.70</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">main</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">status</span></span><br><span class="line">    <span class="attr">plugin:</span></span><br><span class="line">      <span class="attr">gogit-executor-plugin:</span>                    <span class="comment"># 下面支持任何格式给插件传递参数</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">linuxsuren</span></span><br><span class="line">        <span class="attr">repo:</span> <span class="string">test</span></span><br><span class="line">        <span class="attr">pr:</span> <span class="string">&quot;3&quot;</span></span><br></pre></td></tr></table></figure>

<p>这里有<a target="_blank" rel="noopener" href="https://argoproj.github.io/argo-workflows/plugin-directory/">更多社区维护的插件</a>，有通过 Python、Golang、Rust 等语言实现的。</p>
<p>如果你想了解如何开发一个插件，可以继续往后阅读。下面介绍插件机制对 HTTP 的请求、响应的规定：</p>
<ul>
<li>Request payload 中可以解析到与当前工作流的信息，包括：名称、命名空间、插件参数<ul>
<li>我们可以参考 <a target="_blank" rel="noopener" href="https://github.com/argoproj/argo-workflows/blob/774bf47ee678ef31d27669f7d309dee1dd84340c/pkg/plugins/executor/template_executor_plugin.go#L19">ExecuteTemplateArgs</a> 来解析请求</li>
</ul>
</li>
<li>Response 需要告知任务执行的状态<ul>
<li>我们可以参考 <a target="_blank" rel="noopener" href="https://github.com/argoproj/argo-workflows/blob/774bf47ee678ef31d27669f7d309dee1dd84340c/pkg/plugins/executor/template_executor_plugin.go#L32">ExecuteTemplateReply</a> 作为 HTTP 响应的数据</li>
</ul>
</li>
</ul>
<h2 id="归档"><a href="#归档" class="headerlink" title="归档"></a>归档</h2><p>Argo Workflow 支持将工作流执行记录（Workflow）的信息存储到 PostgreSQL 或 MySQL 中，以达到更长久地保存执行记录但又不会影响到<br>Kubernetes 集群的性能。</p>
<p>这里，给出一个归档（ <a target="_blank" rel="noopener" href="https://argoproj.github.io/argo-workflows/workflow-archive/">Archive</a> ）数据到 PostgreSQL 的配置方法：</p>
<p>首先，安装 <a target="_blank" rel="noopener" href="https://www.postgresql.org/">PostgreSQL</a> 。这里采用 Helm Chart 的方式来安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">helm repo add bitnami https://charts.bitnami.com/bitnami</span><br><span class="line">helm repo update</span><br><span class="line">cat &gt; values.yaml &lt;&lt;EOF</span><br><span class="line">auth:</span><br><span class="line">  enablePostgresUser: true</span><br><span class="line">  postgresPassword: &quot;StrongPassword&quot;</span><br><span class="line">  username: &quot;root&quot;</span><br><span class="line">  password: &quot;root&quot;</span><br><span class="line">  database: &quot;app_db&quot;</span><br><span class="line">EOF</span><br><span class="line">helm install postgresql-dev -f values.yaml bitnami/postgresql</span><br></pre></td></tr></table></figure>

<p>Argo Workflows 会以 Secret 的方式读取数据库的用户名、密码，下面是创建 Secret 的命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret generic --from-literal=username=root --from-literal=password=root argo-postgres-config -n argo</span><br></pre></td></tr></table></figure>

<p>然后，参考下面的 ConfigMap 启用工作流的归档功能：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">persistence:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    archive: true</span></span><br><span class="line"><span class="string">    postgresql:</span></span><br><span class="line"><span class="string">      host: postgresql-dev.argocd.svc</span></span><br><span class="line"><span class="string">      port: 5432</span></span><br><span class="line"><span class="string">      database: app_db</span></span><br><span class="line"><span class="string">      tableName: argo_workflows</span></span><br><span class="line"><span class="string">      userNameSecret:</span></span><br><span class="line"><span class="string">        name: argo-postgres-config</span></span><br><span class="line"><span class="string">        key: username</span></span><br><span class="line"><span class="string">      passwordSecret:</span></span><br><span class="line"><span class="string">        name: argo-postgres-config</span></span><br><span class="line"><span class="string">        key: password</span></span><br><span class="line"><span class="string"></span><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">workflow-controller-configmap</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">argo</span></span><br></pre></td></tr></table></figure>

<p>上面的配置步骤都完成，执行工作流后，我们可以在 UI 界面左侧菜单上看到归档的执行记录。也可以通过数据库命令行客户端连接数据库，查看数据的表记录信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export POSTGRES_PASSWORD=root</span><br><span class="line">kubectl run postgresql-dev-client --rm --tty -i --restart=&#x27;Never&#x27; --namespace default --image docker.io/bitnami/postgresql:14.1.0-debian-10-r80 --env=&quot;PGPASSWORD=$POSTGRES_PASSWORD&quot; --command -- psql --host postgresql-dev.argocd.svc -U root -d app_db -p 5432</span><br></pre></td></tr></table></figure>

<p>下面是一些 PostgreSQL 命令行客户端的参考：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">\dt                                                   # 查看当前数据库中的表</span><br><span class="line">select name,phase from argo_archived_workflows;       # 查看已归档的工作流执行记录</span><br></pre></td></tr></table></figure>
<p>你会看到类似如下的输出：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">app_db<span class="operator">=</span><span class="operator">&gt;</span> \dt</span><br><span class="line">                    List <span class="keyword">of</span> relations</span><br><span class="line"> Schema <span class="operator">|</span>              Name              <span class="operator">|</span> Type  <span class="operator">|</span> Owner</span><br><span class="line"><span class="comment">--------+--------------------------------+-------+-------</span></span><br><span class="line"> public <span class="operator">|</span> argo_archived_workflows        <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> root</span><br><span class="line"> public <span class="operator">|</span> argo_archived_workflows_labels <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> root</span><br><span class="line"> public <span class="operator">|</span> argo_workflows                 <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> root</span><br><span class="line"> public <span class="operator">|</span> schema_history                 <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> root</span><br><span class="line">(<span class="number">4</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line">app_db<span class="operator">=</span><span class="operator">&gt;</span> <span class="keyword">select</span> name,phase <span class="keyword">from</span> argo_archived_workflows;</span><br><span class="line">     name     <span class="operator">|</span>   phase</span><br><span class="line"><span class="comment">--------------+-----------</span></span><br><span class="line"> plugin<span class="operator">-</span>pl6rx <span class="operator">|</span> Succeeded</span><br><span class="line"> plugin<span class="number">-8</span>gs7c <span class="operator">|</span> Succeeded</span><br></pre></td></tr></table></figure>

<h2 id="GC"><a href="#GC" class="headerlink" title="GC"></a>GC</h2><p>Argo Workflows 有个工作流执行记录（Workflow）的清理机制，也就是 Garbage Collect(GC)。GC 机制可以避免有太多的执行记录，<br>防止 Kubernetes 的后端存储 Etcd 过载。</p>
<p>我们可以在 ConfigMap 中配置期望保留的工作执行记录数量，这里支持为不同状态的执行记录设定不同的保留数量。配置方法如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">retentionPolicy:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    completed: 3</span></span><br><span class="line"><span class="string">    failed: 3</span></span><br><span class="line"><span class="string">    errored: 3</span></span><br><span class="line"><span class="string"></span><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">workflow-controller-configmap</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">argo</span></span><br></pre></td></tr></table></figure>

<p>需要注意的是，这里的清理机制会将多余的 Workflow 资源从 Kubernetes 中删除。如果希望能更多历史记录的话，建议启用并配置好归档功能。</p>
<p>除了工作流有回收清理机制外，也可以针对 Pod 设置回收机制，参考配置如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">argoproj.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">WorkflowTemplate</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hello-world</span>  <span class="comment"># Name of this Workflow</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podGC:</span></span><br><span class="line">    <span class="attr">strategy:</span> <span class="string">OnPodCompletion</span></span><br></pre></td></tr></table></figure>

<p>清理策略的可选值包括：</p>
<ul>
<li><code>OnPodCompletion</code></li>
<li><code>OnPodSuccess</code></li>
<li><code>OnWorkflowCompletion</code></li>
<li><code>OnWorkflowSuccess</code></li>
</ul>
<p>建议 PodGC 与日志持久化配合使用，不然可能会由于 Pod 被删除后无法查看工作流日志。</p>
<h2 id="可观测"><a href="#可观测" class="headerlink" title="可观测"></a>可观测</h2><p>Argo Workflows 支持通过 Prometheus 采集监控指标，包括：<a target="_blank" rel="noopener" href="https://argoproj.github.io/argo-workflows/metrics/">预定义、自定义</a>的指标，下面是添加自定义指标的示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line">    <span class="attr">prometheus:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">exec_duration_gauge</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">name</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123;workflow.name&#125;&#125;</span>&#x27;</span> <span class="comment"># 工作流名称</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">templatename</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123;workflow.labels.workflows.argoproj.io/workflow-template&#125;&#125;</span>&#x27;</span> <span class="comment"># 工作流模板名称</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">namespace</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123;workflow.namespace&#125;&#125;</span>&#x27;</span> <span class="comment"># 工作流所在命名空间</span></span><br><span class="line">        <span class="attr">help:</span> <span class="string">Duration</span> <span class="string">gauge</span> <span class="string">by</span> <span class="string">name</span></span><br><span class="line">        <span class="attr">gauge:</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123;workflow.duration&#125;&#125;</span>&#x27;</span> <span class="comment"># 工作流执行时长</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">counter:</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">        <span class="attr">help:</span> <span class="string">&quot;Total count of all the failed workflows&quot;</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">name</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123;workflow.name&#125;&#125;</span>&#x27;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">namespace</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123;workflow.namespace&#125;&#125;</span>&#x27;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">templatename</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123;workflow.labels.workflows.argoproj.io/workflow-template&#125;&#125;</span>&#x27;</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">failed_count</span></span><br><span class="line">        <span class="attr">when:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123;workflow.status&#125;&#125;</span> == Failed&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">counter:</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">        <span class="attr">help:</span> <span class="string">&quot;Total count of all the successed workflows&quot;</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">name</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123;workflow.name&#125;&#125;</span>&#x27;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">namespace</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123;workflow.namespace&#125;&#125;</span>&#x27;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">templatename</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123;workflow.labels.workflows.argoproj.io/workflow-template&#125;&#125;</span>&#x27;</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">successed_count</span></span><br><span class="line">        <span class="attr">when:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123;workflow.status&#125;&#125;</span> == Succeeded&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">counter:</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">        <span class="attr">help:</span> <span class="string">&quot;Total count of all the workflows&quot;</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">name</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123;workflow.name&#125;&#125;</span>&#x27;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">namespace</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123;workflow.namespace&#125;&#125;</span>&#x27;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">templatename</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123;workflow.labels.workflows.argoproj.io/workflow-template&#125;&#125;</span>&#x27;</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">total_count</span></span><br></pre></td></tr></table></figure>

<p>上面包含了工作流的成功、失败、总量的数据指标。</p>
<h2 id="工作流默认配置"><a href="#工作流默认配置" class="headerlink" title="工作流默认配置"></a>工作流默认配置</h2><p>在实际场景下，我们往往需要配置不少的工作流模板，而这些模板中也通常会有一些通用的配置项，例如：<br>拉取私有镜像的凭据、Pod 回收策略、卷挂载等待。我们可以把这些公共配置加到 ConfigMap 中，请参考如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">workflowDefaults:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      podGC:</span></span><br><span class="line"><span class="string">        strategy: OnPodCompletion           # Pod 完成后即删除</span></span><br><span class="line"><span class="string">      imagePullSecrets:</span></span><br><span class="line"><span class="string">      - name: harbor-pull                   # 公共的私有镜像拉取凭据</span></span><br><span class="line"><span class="string">      volumeClaimTemplates:                 # 默认的代码拉取卷位置</span></span><br><span class="line"><span class="string">        - metadata:</span></span><br><span class="line"><span class="string">            name: work</span></span><br><span class="line"><span class="string">          spec:</span></span><br><span class="line"><span class="string">            accessModes: [&quot;ReadWriteOnce&quot;]</span></span><br><span class="line"><span class="string">            resources:</span></span><br><span class="line"><span class="string">              requests:</span></span><br><span class="line"><span class="string">                storage: 64Mi</span></span><br><span class="line"><span class="string"></span><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">workflow-controller-configmap</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">argo</span></span><br></pre></td></tr></table></figure>

<h2 id="Golang-SDK"><a href="#Golang-SDK" class="headerlink" title="Golang SDK"></a>Golang SDK</h2><p>Argo Workflows 官方<a target="_blank" rel="noopener" href="https://argoproj.github.io/argo-workflows/client-libraries/">维护了 Golang、Java、Python 语言</a>的 SDK。下面以 Golang 为例，讲解 SDK 的使用方法。</p>
<p>在运行下面的示例前，有两点需要注意的：</p>
<ul>
<li>Argo Workflows Server 地址</li>
<li>Token</li>
</ul>
<p>你可以选择直接使用 <code>argo-server</code> 的 Service 地址，将端口 <code>2746</code> 转发到本地，或将 Service 修改为 <code>NodePort</code>，或者其他方法暴露端口。也可以执行下面的命令，再启动一个 Argo 服务：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">argo server</span><br></pre></td></tr></table></figure>

<p>第二个，就是用户认证的问题了。如果你对 Kubernetes 认证系统非常熟悉的话，可以跳过这一段，直接找一个 Token。为了让你对 Argo 的用户认证更加了解，我们为下面的测试代码创建一个新的 ServiceAccount。</p>
<p>我们需要分别创建：</p>
<ul>
<li>Role，规定可以对哪些资源有哪些操作权限</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create role demo --verb=get,list,update,create --resource=workflows.argoproj.io --resource=workflowtemplates.argoproj.io -n default</span><br></pre></td></tr></table></figure>

<ul>
<li>ServiceAccount，代表一个用户</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create serviceaccount demo -n default</span><br></pre></td></tr></table></figure>

<ul>
<li>RoleBinding，将用户和角色（Role）进行绑定</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create rolebinding demo --role=demo --serviceaccount=default:demo -n default</span><br></pre></td></tr></table></figure>

<ul>
<li>Secret，关联一个 ServiceAccount，并自动生成 Token</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -n default -f - &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: demo.service-account-token</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/service-account.name: demo</span><br><span class="line">type: kubernetes.io/service-account-token</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上面的例子中，我们使用的是 <code>Role</code> 和 <code>RoleBinding</code> ，这样的角色只能允许访问所在命名空间（namespace）的资源。上面创建的用户，只能够访问 <code>default</code> 这命名空间下的 <code>Workflow</code> 和 <code>WorkflowTemplate</code> 。<br>如果想要创建一个全局的角色以及绑定，可以使用 <code>ClusterRole</code> 和 <code>ClusterRoleBinding</code> 。</p>
</blockquote>
<p>上面的用户创建完成后，我们就可以通过下面的命令拿到指定权限的 <code>Token</code> 了：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secret -n default demo.service-account-token -ojsonpath=&#123;.data.token&#125;|base64 -d</span><br></pre></td></tr></table></figure>

<p>接下来，创建一个 Golang 工程，并将下面的示例代码拷贝到源文件 <code>main.go</code> 中。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir demo</span><br><span class="line">cd demo</span><br><span class="line">go mod init github.com/linuxsuren/demo</span><br><span class="line">go get github.com/argoproj/argo-workflows/v3@v3.4.4</span><br><span class="line">go mod tidy</span><br></pre></td></tr></table></figure>

<p>示例代码：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/argoproj/argo-workflows/v3/pkg/apiclient&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/argoproj/argo-workflows/v3/pkg/apiclient/workflow&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/argoproj/argo-workflows/v3/pkg/apiclient/workflowtemplate&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/argoproj/argo-workflows/v3/pkg/apis/workflow/v1alpha1&quot;</span></span><br><span class="line">	metav1 <span class="string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">** Before run this demo, please create a parameterless WorkflowTemplate in namespace default.</span></span><br><span class="line"><span class="comment">** In this demo, we will print all the WorkflowTemplates in namespace default.</span></span><br><span class="line"><span class="comment">** Then run a Workflow base on the first WorkflowTemplate.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	opt := apiclient.Opts&#123;</span><br><span class="line">		ArgoServerOpts: apiclient.ArgoServerOpts&#123;</span><br><span class="line">			URL:                <span class="string">&quot;localhost:31808&quot;</span>, <span class="comment">// argo-server address</span></span><br><span class="line">			Path:               <span class="string">&quot;/&quot;</span>,</span><br><span class="line">			Secure:             <span class="literal">true</span>,</span><br><span class="line">			InsecureSkipVerify: <span class="literal">true</span>,</span><br><span class="line">		&#125;,</span><br><span class="line">		AuthSupplier: <span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="type">string</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;Bearer your-token&quot;</span></span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	ctx, client, err := apiclient.NewClientFromOpts(opt) <span class="comment">// the context will carry on auth</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	wftClient, err := client.NewWorkflowTemplateServiceClient()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;failed to get the WorkflowTemplates client&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	defaultNamespace := <span class="string">&quot;default&quot;</span></span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">&quot;get the WorkflowTemplate list from&quot;</span>, defaultNamespace)</span><br><span class="line">	wftList, err := wftClient.ListWorkflowTemplates(ctx, &amp;workflowtemplate.WorkflowTemplateListRequest&#123;</span><br><span class="line">		Namespace: defaultNamespace,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;failed to list WorkflowTemplates&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> _, wft := <span class="keyword">range</span> wftList.Items &#123;</span><br><span class="line">		fmt.Println(wft.Namespace, wft.Name)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> wftList.Items.Len() &gt; <span class="number">0</span> &#123;</span><br><span class="line">		wft := wftList.Items[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">		wfClient := client.NewWorkflowServiceClient()</span><br><span class="line">		_, err := wfClient.CreateWorkflow(ctx, &amp;workflow.WorkflowCreateRequest&#123;</span><br><span class="line">			Namespace: defaultNamespace,</span><br><span class="line">			Workflow: &amp;v1alpha1.Workflow&#123;</span><br><span class="line">				ObjectMeta: metav1.ObjectMeta&#123;</span><br><span class="line">					GenerateName: wft.Name,</span><br><span class="line">				&#125;,</span><br><span class="line">				Spec: v1alpha1.WorkflowSpec&#123;</span><br><span class="line">					WorkflowTemplateRef: &amp;v1alpha1.WorkflowTemplateRef&#123;</span><br><span class="line">						Name: wft.Name,</span><br><span class="line">					&#125;,</span><br><span class="line">				&#125;,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(<span class="string">&quot;failed to create workflow&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后，执行命令：<code>go run .</code></p>
<blockquote>
<p>把上面的示例代码编译后，二进制文件大致在 60M+</p>
</blockquote>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/LinuxSuRen/devops-practice-guide">DevOps Practice Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/LinuxSuRen/argo-cd-guide">Argo CD Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/LinuxSuRen/argo-rollouts-guide">Argo Rollouts Guide</a></li>
<li><a href="templates/README.md">更多场景下的模板样例</a></li>
</ul>
<h2 id="原文地址"><a href="#原文地址" class="headerlink" title="原文地址"></a>原文地址</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/devops-ws/argo-workflows-guide/blob/master/README.md?plain=1">https://github.com/devops-ws/argo-workflows-guide/blob/master/README.md?plain=1</a></p>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://wongearl.github.io">Earl Wong</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://wongearl.github.io/2023/11/17/gitops/argo-workflow-guide/">https://wongearl.github.io/2023/11/17/gitops/argo-workflow-guide/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://wongearl.github.io" target="_blank">Earl Wong</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/argo-workflows/">argo-workflows</a></div><div class="post_share"><div class="social-share" data-image="/img/20230818103122.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2023/11/15/golang/goland_code_rule/" title="如何真正写好Golang代码?"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">如何真正写好Golang代码?</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/20230818103122.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Earl Wong</div><div class="author-info__description">Share everything</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">25</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/wongearl"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/wongearl" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:earlwong368@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">1.</span> <span class="toc-text">基本概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">2.</span> <span class="toc-text">最佳实践</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">3.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E8%AE%BF%E9%97%AE%E6%96%B9%E5%BC%8F"><span class="toc-number">4.</span> <span class="toc-text">设置访问方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E7%A4%BA%E4%BE%8B"><span class="toc-number">5.</span> <span class="toc-text">简单示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">5.1.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E7%A4%BA%E4%BE%8B"><span class="toc-number">6.</span> <span class="toc-text">完整示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-1"><span class="toc-number">6.1.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F"><span class="toc-number">7.</span> <span class="toc-text">构建镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-2"><span class="toc-number">7.1.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AA%E7%8E%AF%E4%BB%BB%E5%8A%A1"><span class="toc-number">8.</span> <span class="toc-text">循环任务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E6%9E%9C%E8%BE%93%E5%87%BA%E4%B8%8E%E5%BC%95%E7%94%A8"><span class="toc-number">9.</span> <span class="toc-text">结果输出与引用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Webhook"><span class="toc-number">10.</span> <span class="toc-text">Webhook</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-3"><span class="toc-number">10.1.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E8%81%94%E4%BB%A3%E7%A0%81%E4%BB%93%E5%BA%93"><span class="toc-number">11.</span> <span class="toc-text">关联代码仓库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">11.1.</span> <span class="toc-text">参考链接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-4"><span class="toc-number">11.2.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">12.</span> <span class="toc-text">日志持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5-1"><span class="toc-number">12.1.</span> <span class="toc-text">参考链接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-5"><span class="toc-number">12.2.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E7%94%A8%E5%B7%B2%E6%9C%89%E6%A8%A1%E6%9D%BF%E4%B8%AD%E7%9A%84%E4%BB%BB%E5%8A%A1"><span class="toc-number">13.</span> <span class="toc-text">引用已有模板中的任务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-6"><span class="toc-number">13.1.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E6%A8%A1%E6%9D%BF%E7%B1%BB%E5%9E%8B"><span class="toc-number">14.</span> <span class="toc-text">任务模板类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E6%A8%A1%E5%9E%8B"><span class="toc-number">15.</span> <span class="toc-text">认证模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SSO"><span class="toc-number">16.</span> <span class="toc-text">SSO</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-7"><span class="toc-number">16.1.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%92%E4%BB%B6%E6%9C%BA%E5%88%B6"><span class="toc-number">17.</span> <span class="toc-text">插件机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BD%92%E6%A1%A3"><span class="toc-number">18.</span> <span class="toc-text">归档</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GC"><span class="toc-number">19.</span> <span class="toc-text">GC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E8%A7%82%E6%B5%8B"><span class="toc-number">20.</span> <span class="toc-text">可观测</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE"><span class="toc-number">21.</span> <span class="toc-text">工作流默认配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Golang-SDK"><span class="toc-number">22.</span> <span class="toc-text">Golang SDK</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-number">23.</span> <span class="toc-text">References</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E6%96%87%E5%9C%B0%E5%9D%80"><span class="toc-number">24.</span> <span class="toc-text">原文地址</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/11/17/gitops/argo-workflow-guide/" title="argo-workflows-guide">argo-workflows-guide</a><time datetime="2023-11-17T01:33:50.000Z" title="发表于 2023-11-17 09:33:50">2023-11-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/11/15/golang/goland_code_rule/" title="如何真正写好Golang代码?">如何真正写好Golang代码?</a><time datetime="2023-11-15T01:38:47.000Z" title="发表于 2023-11-15 09:38:47">2023-11-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/11/13/%E4%BA%BA%E7%94%9F%E6%84%9F%E6%82%9F/%E4%BA%BA%E7%94%9F%E6%84%9F%E6%82%9F/" title="人生感悟">人生感悟</a><time datetime="2023-11-13T06:58:59.000Z" title="发表于 2023-11-13 14:58:59">2023-11-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/11/09/kubernetes/promql/" title="PromQL全解析">PromQL全解析</a><time datetime="2023-11-09T02:15:00.000Z" title="发表于 2023-11-09 10:15:00">2023-11-09</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/11/03/kubernetes/snat-dnat/" title="SNAT和DNAT">SNAT和DNAT</a><time datetime="2023-11-03T07:20:21.000Z" title="发表于 2023-11-03 15:20:21">2023-11-03</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Earl Wong</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>